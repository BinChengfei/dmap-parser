#include "dmap_parser.h"
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdarg.h>
#include <fcntl.h>

char output[2048] = {0};
size_t outpos = 0;

typedef struct {
	const char msg[1024];
	size_t msglen;
	const char* expected;
} test;

test tests[] = {
{
	.msg = { 0x6d, 0x6c, 0x6f, 0x67, 0x00, 0x00, 0x00, 0x18, 0x6d, 0x73, 0x74,
		     0x74, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0xc8, 0x6d, 0x6c,
			 0x69, 0x64, 0x00, 0x00, 0x00, 0x04, 0x3b, 0x9a, 0x7c, 0x99 },
	.msglen = 32,
	.expected = \
	"dmap.loginresponse:\n"
	"  dmap.status: 200\n"
	"  dmap.sessionid: 999980185\n"
},
{
	.msg = { 0x6d, 0x6c, 0x69, 0x74, 0x00, 0x00, 0x00, 0x30, 0x6d, 0x69, 0x69,
		     0x64, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x29, 0x6b, 0x6d, 0x69,
			 0x6e, 0x6d, 0x00, 0x00, 0x00, 0x10, 0x41, 0x6c, 0x74, 0x65, 0x72,
			 0x6e, 0x61, 0x74, 0x69, 0x76, 0x65, 0x20, 0x52, 0x6f, 0x63, 0x6b,
			 0x6d, 0x69, 0x6d, 0x63, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x01,
			 0x05 },
	.msglen = 56,
	.expected = \
	"dmap.listingitem:\n"
	"  dmap.itemid: 10603\n"
	"  dmap.itemname: Alternative Rock\n"
	"  dmap.itemcount: 261\n"
},
{
	.msg = { 0x63, 0x61, 0x73, 0x70, 0x00, 0x00, 0x00, 0xf5, 0x6d, 0x73, 0x74,
		     0x74, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0xc8, 0x6d, 0x64,
		     0x63, 0x6c, 0x00, 0x00, 0x00, 0x3e, 0x6d, 0x69, 0x6e, 0x6d, 0x00,
		     0x00, 0x00, 0x08, 0x43, 0x6f, 0x6d, 0x70, 0x75, 0x74, 0x65, 0x72,
		     0x63, 0x6d, 0x76, 0x6f, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
		     0x64, 0x63, 0x61, 0x76, 0x64, 0x00, 0x00, 0x00, 0x01, 0x01, 0x6d,
		     0x73, 0x6d, 0x61, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00,
		     0x00, 0x00, 0x00, 0x00, 0x63, 0x61, 0x69, 0x61, 0x00, 0x00, 0x00,
		     0x01, 0x01, 0x6d, 0x64, 0x63, 0x6c, 0x00, 0x00, 0x00, 0x35, 0x6d,
		     0x69, 0x6e, 0x6d, 0x00, 0x00, 0x00, 0x08, 0x41, 0x70, 0x70, 0x6c,
		     0x65, 0x20, 0x54, 0x56, 0x63, 0x6d, 0x76, 0x6f, 0x00, 0x00, 0x00,
		     0x04, 0x00, 0x00, 0x00, 0x64, 0x6d, 0x73, 0x6d, 0x61, 0x00, 0x00,
		     0x00, 0x08, 0x00, 0x00, 0x70, 0x73, 0xcb, 0xd4, 0x98, 0x72, 0x63,
		     0x61, 0x69, 0x76, 0x00, 0x00, 0x00, 0x01, 0x01, 0x6d, 0x64, 0x63,
		     0x6c, 0x00, 0x00, 0x00, 0x2b, 0x63, 0x6d, 0x76, 0x6f, 0x00, 0x00,
		     0x00, 0x04, 0x00, 0x00, 0x00, 0x64, 0x6d, 0x69, 0x6e, 0x6d, 0x00,
		     0x00, 0x00, 0x07, 0x42, 0x65, 0x64, 0x72, 0x6f, 0x6f, 0x6d, 0x6d,
		     0x73, 0x6d, 0x61, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x44, 0xd8,
		     0x84, 0x6a, 0xb6, 0xfc, 0x6d, 0x64, 0x63, 0x6c, 0x00, 0x00, 0x00,
		     0x2b, 0x63, 0x6d, 0x76, 0x6f, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00,
		     0x00, 0x64, 0x6d, 0x69, 0x6e, 0x6d, 0x00, 0x00, 0x00, 0x07, 0x4b,
		     0x69, 0x74, 0x63, 0x68, 0x65, 0x6e, 0x6d, 0x73, 0x6d, 0x61, 0x00,
		     0x00, 0x00, 0x08, 0x00, 0x00, 0xf0, 0xb4, 0x79, 0x05, 0x66, 0x0a },
	.msglen = 253,
	.expected = \
	"dacp.speakers:\n"
	"  dmap.status: 200\n"
	"  dmap.dictionary:\n"
	"    dmap.itemname: Computer\n"
	"    dmcp.volume: 100\n"
	"    cavd: 1\n"
	"    dmap.machineaddress: 0\n"
	"    dacp.isactive: 1\n"
	"  dmap.dictionary:\n"
	"    dmap.itemname: Apple TV\n"
	"    dmcp.volume: 100\n"
	"    dmap.machineaddress: 123642643257458\n"
	"    caiv: 1\n"
	"  dmap.dictionary:\n"
	"    dmcp.volume: 100\n"
	"    dmap.itemname: Bedroom\n"
	"    dmap.machineaddress: 75696725210876\n"
	"  dmap.dictionary:\n"
	"    dmcp.volume: 100\n"
	"    dmap.itemname: Kitchen\n"
	"    dmap.machineaddress: 264657915176458\n"
}
};

char prefix[64] = {0};

void indent() {
	strcat(prefix, "  ");
}

void outdent() {
	size_t len = strlen(prefix);
	if (len >= 2) {
		prefix[len - 2] = '\0';
	}
}

void append(const char* line, ...) {
	va_list args;
	va_start(args, line);

	strcat(&output[outpos], prefix);
	outpos += strlen(prefix);
	outpos += vsprintf(&output[outpos], line, args);
	strcat(&output[outpos], "\n");
	outpos++;

	va_end(args);
}

void on_dict_start(void *ctx, const char *code, const char *name) {
	append("%s:", name);
	indent();
}

void on_dict_end(void *ctx, const char *code, const char *name) {
	outdent();
}

void on_int32(void *ctx, const char *code, const char *name, int32_t value) {
	append("%s: %d", name, value);
}

void on_int64(void *ctx, const char *code, const char *name, int64_t value) {
	append("%s: %lld", name, value);
}

void on_uint32(void *ctx, const char *code, const char *name, uint32_t value) {
	append("%s: %u", name, value);
}

void on_uint64(void *ctx, const char *code, const char *name, uint64_t value) {
	append("%s: %llu", name, value);
}

void on_date(void *ctx, const char *code, const char *name, uint32_t value) {
	append("date: %s (%s) %d\n", code, name, value);
}

void on_string(void *ctx, const char *code, const char *name, const char *buf, size_t len) {
	char *str = (char *)malloc(len + 1);
	strncpy(str, buf, len);
	str[len] = '\0';
	append("%s: %s", name, str);
	free(str);
}

void on_data(void *ctx, const char *code, const char *name, const char *buf, size_t len) {
	append("data: %s (%s)\n", code, name);
}

int main() {
	dmap_settings settings = {};
	settings.on_dict_start = on_dict_start;
	settings.on_dict_end = on_dict_end;
	settings.on_int32 = on_int32;
	settings.on_int64 = on_int64;
	settings.on_uint32 = on_uint32;
	settings.on_uint64 = on_uint64;
	settings.on_date = on_date;
	settings.on_string = on_string;
	settings.on_data = on_data;

	size_t i;
	size_t count = sizeof(tests) / sizeof(test);
	printf("Running %zu tests\n", count);
	for (i = 0; i < count; i++) {
		output[0] = '\0';
		outpos = 0;
		dmap_parse(&settings, tests[i].msg, tests[i].msglen);
		if (strcmp(output, tests[i].expected) != 0) {
			printf("Test failed! Expected:\n%sActual:\n%s\n",
					tests[i].expected,
					output);
		}
	}
	return 0;
}
